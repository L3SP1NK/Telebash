#!/bin/bash
## Send messages/documents with your Telegram bot.
## Check telegram-cli if you want more advanced features.

## Set colors.
RC="\e[0m"
YELLOW="\e[33m"
GREEN="\e[32m"
CYAN="\e[36m"
RED="\e[31m"
BOLD="\e[1m"
UL="\e[4m"
ITALIC="\e[3m"

TELEBASH_PATH="${HOME}/.config/telebash"
TELEGRAM_TOKEN="${TELEBASH_PATH}/telegram_token.txt"
TELEBASH_LOGO="${TELEBASH_PATH}/logo.txt"

if [[ -f ${TELEGRAM_TOKEN} ]]
	then
		source ${TELEGRAM_TOKEN}
		[[ ${TELEGRAM_TOKEN} == "" ]] && echo -e "\n${RED}${BOLD}Token${RED}${BOLD} config file found but contain nothing!${RC}\n${RED}Exiting...\n"
	else
		echo -e "\n${RED}${BOLD}Token is missing!${RC}\n Get one with ${CYAN}@botfather${RC} on Telegram.\n" && exit 1
fi

DISPLAY_HELP()
{
	[[ -f ${TELEBASH_LOGO} ]] && cat ${TELEBASH_LOGO}
	echo -e " ${UL}Usage:${RC}"
	echo -e "  ./telebash <chat ID> <options> <text>\n"
	echo -e "  To get a chat ID, run this script with the '-u' flag.\n"
	echo -e " ${UL}Options:${RC}"
	echo -e "  ${YELLOW}-c,	--command${RC}		<command>			Display the command output.${RC}"
	echo -e "  ${YELLOW}-h,	--help${RC}							Display this help.${RC}"
	echo -e "  ${YELLOW}-t,	--text${RC}			<text>				Send a text message.${RC}"
	echo -e "  ${YELLOW}-u,	--update${RC}						Get the latest infos (groups, messages...)${RC}\n"
}

TELEGRAM_API="https://api.telegram.org/bot${TELEGRAM_TOKEN}"
TELEGRAM_CHAT_ID="${1}"

SEND_MESSAGE()
{
	ENDPOINT="sendMessage"
	PARSE_MODE="html" ## "html" or "markdown"
	curl -s -d "chat_id=${TELEGRAM_CHAT_ID}&parse_mode=${PARSE_MODE}&text=${TEXT}" ${TELEGRAM_API}/${ENDPOINT} | jq
}

GET_UPDATE()

{
	curl -s "https://api.telegram.org/bot${TELEGRAM_TOKEN}/getUpdates" | jq
}

REQUIREMENTS="curl jq"
if ! which ${REQUIREMENTS} > /dev/null
	then
		echo -e "${YELLOW}${BOLD} \n To run this program, you need the following packages installed: ${REQUIREMENTS}\n${RED}${BOLD} Exiting...\n"
		exit 1
	else
		case ${2} in
			-c|--command)
				TEXT=$(${3})
				SEND_MESSAGE
				;;
			-h| --help)
				DISPLAY_HELP
				;;
			-t|--text)
				TEXT="${3}"
				SEND_MESSAGE
				;;
			-u| --update)
				GET_UPDATE
				;;
			*)
				DISPLAY_HELP
				;;
		esac
fi
